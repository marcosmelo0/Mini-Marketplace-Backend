generator client {
    provider = "prisma-client-js"
    output   = "../src/lib/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum Role {
    CLIENT
    PROVIDER
}

enum BookingStatus {
    CONFIRMED
    CANCELLED
    COMPLETED
}

model User {
    id            String   @id @default(uuid())
    name          String
    email         String   @unique
    password_hash String
    role          Role     @default(CLIENT)
    phone         String?
    created_at    DateTime @default(now())
    updated_at    DateTime @updatedAt

    services       Service[]
    availabilities Availability[]
    bookings       Booking[]
    refreshTokens  RefreshToken[]
    reviews        Review[]
    notifications  Notification[]
}

model RefreshToken {
    id         String   @id @default(uuid())
    userId     String
    token      String   @unique
    expiresAt  DateTime
    created_at DateTime @default(now())
    revoked    Boolean  @default(false)

    user User @relation(fields: [userId], references: [id])
}

model Service {
    id          String   @id @default(uuid())
    providerId  String
    name        String
    description String
    category    String
    photos      String[]
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt

    provider   User               @relation(fields: [providerId], references: [id])
    variations ServiceVariation[]
    reviews    Review[]

    @@index([category])
    @@index([providerId])
}

model ServiceVariation {
    id                  String   @id @default(uuid())
    serviceId           String
    name                String
    price               Decimal
    duration_minutes    Int
    discount_percentage Int?     @default(0)
    discount_days       Int[]    @default([])
    created_at          DateTime @default(now())
    updated_at          DateTime @updatedAt

    service  Service   @relation(fields: [serviceId], references: [id])
    bookings Booking[]
}

model Availability {
    id          String   @id @default(uuid())
    providerId  String
    day_of_week Int
    start_time  DateTime
    end_time    DateTime
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt

    provider User @relation(fields: [providerId], references: [id])

    @@index([providerId, day_of_week])
}

model Booking {
    id                 String        @id @default(uuid())
    clientId           String
    serviceVariationId String
    start_time         DateTime
    end_time           DateTime
    status             BookingStatus @default(CONFIRMED)
    final_price        Decimal?
    created_at         DateTime      @default(now())
    updated_at         DateTime      @updatedAt

    client           User             @relation(fields: [clientId], references: [id])
    serviceVariation ServiceVariation @relation(fields: [serviceVariationId], references: [id])
    notifications    Notification[]

    @@index([status, end_time])
    @@index([clientId])
    @@index([serviceVariationId])
    @@index([start_time, end_time])
}

model Review {
    id         String   @id @default(uuid())
    serviceId  String
    clientId   String
    rating     Int
    comment    String?
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    service Service @relation(fields: [serviceId], references: [id])
    client  User    @relation(fields: [clientId], references: [id])

    @@unique([serviceId, clientId])
    @@index([serviceId])
}

model Notification {
    id         String   @id @default(uuid())
    providerId String
    type       String
    title      String
    message    String
    read       Boolean  @default(false)
    bookingId  String?
    created_at DateTime @default(now())

    provider User     @relation(fields: [providerId], references: [id])
    booking  Booking? @relation(fields: [bookingId], references: [id])

    @@index([providerId, read])
}
